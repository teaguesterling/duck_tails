# name: test/sql/test_git_context_manager.test
# description: Isolated tests for GitContextManager unified git URI processing architecture
# group: [sql]

require duck_tails

# Use __BUILD_DIRECTORY__ to ensure we load the freshly built extension
statement ok
SET extension_directory='__BUILD_DIRECTORY__/extension';

statement ok
PRAGMA enable_verification;

# NOTE: This test requires fixtures to be set up. Use: make fixtures

# =========================================================================
# GitContextManager Core Functionality Tests
# =========================================================================

# Test 1: Basic git:// URI parsing and repository discovery
query I
SELECT COUNT(*) > 0 as has_commits FROM git_log_each('git://test/tmp/main-repo@HEAD')
----
true

# Test 2: Filesystem path processing with repository discovery
query I
SELECT COUNT(*) > 0 as has_commits FROM git_log_each('test/tmp/main-repo')
----
true

# Test 3: Invalid ref validation - should consistently fail with "unable to parse OID"
statement error
SELECT * FROM git_log_each('git://test/tmp/main-repo@invalid@@@@ref')
----
unable to parse OID

statement error
SELECT * FROM git_log_each('git://test/tmp/main-repo@nonexistent-ref-12345')
----
unable to parse OID

# Test 4: Invalid repository paths
statement error
SELECT * FROM git_log_each('/absolutely/nonexistent/repository/path')
----
No git repository found

# Test 4a: Repository discovery behavior - relative paths with no "../" will find repo at pwd
# Since we're running from within duck_tails repo, this will find it
# May return empty results if path filtering is applied
query I
SELECT COUNT(*) >= 0 as query_succeeded
FROM git_log_each('git://nonexistent/repo@HEAD')
----
true

# Test 4b: Repository discovery behavior - absolute paths should always fail
statement error
SELECT * FROM git_log_each('git:///absolutely/nonexistent/path@HEAD')
----
No git repository found

# Test 5: File path extraction and processing
query I
SELECT COUNT(*) >= 0 as valid_file_filtering FROM git_log_each('git://test/tmp/main-repo/README.md@HEAD')
----
true

# Test 6: Repository caching - multiple calls should work efficiently
query I
SELECT COUNT(*) > 0 as first_call FROM git_log_each('git://test/tmp/main-repo@HEAD')
----
true

query I
SELECT COUNT(*) > 0 as second_call FROM git_log_each('git://test/tmp/main-repo@HEAD')
----
true

query I
SELECT COUNT(*) > 0 as third_call FROM git_log_each('git://test/tmp/main-repo@HEAD')
----
true

# Test 7: LATERAL join operations with mixed valid/invalid URIs
query I
WITH test_uris(uri) AS (
    VALUES 
        ('git://test/tmp/main-repo@HEAD'),
        ('git://test/tmp/main-repo/README.md@HEAD')
)
SELECT COUNT(*) >= 1 as has_results
FROM test_uris t, LATERAL git_log_each(t.uri) g
----
true

# Test 8: NULL URI handling in LATERAL context
query I
WITH test_uris(uri) AS (
    VALUES 
        ('git://test/tmp/main-repo@HEAD'),
        (NULL),
        ('git://test/tmp/main-repo/README.md@HEAD')
)
SELECT COUNT(*) >= 1 as has_results
FROM test_uris t, LATERAL git_log_each(t.uri) g
WHERE t.uri IS NOT NULL
----
true

# Test 9: Repository path consistency
query I
SELECT COUNT(DISTINCT repo_path) = 1 as consistent_repo_path
FROM git_log_each('git://test/tmp/main-repo@HEAD')
----
true

# Test 10: Complex URI parsing with subdirectories
query I
SELECT COUNT(*) >= 0 as processes_subdirs
FROM git_log_each('git://test/tmp/main-repo/src@HEAD')
----
true

# =========================================================================
# GitContextManager Error Consistency Tests
# =========================================================================

# Test 11: Consistency across different invalid ref formats
statement error
SELECT * FROM git_log_each('git://test/tmp/main-repo@@@invalid')
----
unable to parse OID

statement error
SELECT * FROM git_log_each('git://test/tmp/main-repo@invalid@ref@format')
----
unable to parse OID

statement error  
SELECT * FROM git_log_each('git://test/tmp/main-repo@!@#$%^&*()')
----
unable to parse OID

# Test 12: Various malformed URI formats - empty ref defaults to HEAD
query I
SELECT COUNT(*) > 0 as has_results FROM git_log_each('git://test/tmp/main-repo@')
----
true

# Empty repo path defaults to current directory
query I
SELECT COUNT(*) > 0 as has_results FROM git_log_each('git://@HEAD')
----
true

# Test 13: Repository discovery edge cases
statement error
SELECT * FROM git_log_each('git:///absolutely/nonexistent/repository/path@HEAD')
----
No git repository found

# =========================================================================
# GitContextManager Performance and Memory Tests
# =========================================================================

# Test 14: Performance with large LATERAL operations
statement ok
CREATE TEMP TABLE large_test AS
WITH RECURSIVE series(x) AS (
    SELECT 1
    UNION ALL
    SELECT x + 1 FROM series WHERE x < 10
)
SELECT 'git://test/tmp/main-repo@HEAD' as uri
FROM series;

query I
SELECT COUNT(*) >= 10 as performance_test
FROM large_test t, LATERAL git_log_each(t.uri) g
LIMIT 10
----
true

# Test 15: Memory efficiency - repository caching working
query I
WITH repos(path) AS (
    VALUES 
        ('git://test/tmp/main-repo@HEAD'),
        ('git://test/tmp/main-repo@HEAD'),
        ('git://test/tmp/main-repo@HEAD')
)
SELECT COUNT(*) >= 3 as cache_test
FROM repos r, LATERAL git_log_each(r.path) g
----
true

# =========================================================================
# GitContextManager Integration Tests
# =========================================================================

# Test 16: Verify GitContextManager provides consistent behavior
# Note: This should match the behavior we'll get when all git_* functions use GitContextManager

# Current behavior: git_log_each uses GitContextManager (should fail consistently)
statement error
SELECT * FROM git_log_each('git://test/tmp/main-repo@invalid@@ref')
----
unable to parse OID

# Test 17: File filtering functionality
query I
SELECT COUNT(*) <= 10 as reasonable_file_filter_count
FROM git_log_each('git://test/tmp/main-repo/README.md@HEAD')
----
true

# Test 18: Valid ref formats
query I
SELECT COUNT(*) > 0 as head_ref FROM git_log_each('git://test/tmp/main-repo@HEAD')
----
true

# Test 19: Repository path normalization
query I
SELECT repo_path LIKE '%/test/tmp/main-repo' as normalized_path
FROM git_log_each('git://test/tmp/main-repo@HEAD')
LIMIT 1
----
true

# Test 20: Final verification - GitContextManager is working
statement ok
SELECT 'GitContextManager core tests completed successfully' as result;

# =========================================================================
# Expected Future Behavior Tests (when all functions use GitContextManager)
# =========================================================================

# These tests document what we expect once ALL git_* functions use GitContextManager

# Future Test: All git_* functions should have consistent error messages
# statement error
# SELECT * FROM git_tree('git://test/tmp/main-repo@invalid@@ref')
# ----
# unable to parse OID

# Future Test: All git_* functions should handle repository discovery consistently  
# statement error
# SELECT * FROM git_read('git://nonexistent/repo/file.txt@HEAD')
# ----
# GitContextManager: Failed to open repository

statement ok
SELECT 'GitContextManager test suite completed - ready for full git_* function integration' as final_result;
